<!DOCTYPE html>
<html lang="cs">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Konfigurátor</title>
		<meta name="description" content="Konfigurátor úvodního slidu Czechitas." />
		<link rel="shortcut icon" href="icons/icon-48x48.png" />
		<link rel="preconnect" href="https://fonts.gstatic.com" />
		<link
			href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap"
			rel="stylesheet"
		/>
		<meta name="color-scheme" content="light dark" />
		<meta name="theme-color" content="#000000" />
		<link rel="manifest" href="webmanifest.json" />
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			body {
				font-family: sans-serif;
			}
			.main {
				max-width: 80ex;
				margin: 2em auto 8em;
			}
			label,
			button {
				display: block;
				cursor: pointer;
			}
			label + label {
				margin-top: 1.5em;
			}
			label {
				display: grid;
				row-gap: 0.3em;
			}
			textarea,
			input:not([type='checkbox']),
			button {
				width: 100%;
				font-size: 2em;
				font-family: 'Open Sans', sans-serif;
			}
			textarea {
				resize: vertical;
				min-height: 3em;
				font-size: 3em;
			}
			button {
				margin-top: 1em;
				padding: 0.1em 1em;
			}
			h1,
			.note {
				text-align: center;
			}
			.preview {
				position: relative;
				margin-bottom: 2em;
				overflow: hidden;
			}
			.preview::before {
				content: '';
				display: block;
				padding-top: calc(100% / (16 / 9));
			}
			.preview-in {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				border: none;
			}
			.actions {
				display: grid;
				grid-template-columns: 1fr auto;
				column-gap: 0.5em;
			}
			.actions a {
				text-decoration: none;
			}
		</style>
	</head>
	<body>
		<main class="main">
			<h1>Czechitas konfigurátor intro slidu</h1>
			<div class="preview">
				<canvas class="preview-in" id="preview"></canvas>
			</div>
			<form action="slide.html">
				<label>
					Nadpis:
					<textarea name="title" placeholder="Úvod do HTML a CSS"></textarea>
				</label>
				<label>
					Řádek 1:
					<input name="meta1" autocomplete="name" placeholder="Filip Chalupa" />
				</label>
				<label>
					Řádek 2:
					<input name="meta2" placeholder="18. 2. 2021" />
				</label>
				<label>
					Řádek 3:
					<input
						name="meta3"
						autocomplete="address-level2"
						placeholder="Praha"
					/>
				</label>
				<label>
					<span>
						URL ikony:
						<small>(server s obrázkem musí umožňovat vkládání)</small>
					</span>
					<input
						type="url"
						name="icon"
						placeholder="https://placekitten.com/400/400"
					/>
				</label>
				<div class="actions">
					<button type="submit">Zobrazit výsledek</button>
					<a id="download" download="thumbnail.png">
						<button type="button">
							Stáhnout
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="24"
								height="24"
								viewBox="0 0 24 24"
							>
								<path
									d="M15.003 3h2.997v5h-2.997v-5zm8.997 1v20h-24v-24h20l4 4zm-19 5h14v-7h-14v7zm16 4h-18v9h18v-9z"
									fill="currentColor"
								/>
							</svg>
						</button>
					</a>
				</div>
				<p class="note">
					Doporučená velikost okna pro zobrazení výsledku je 16:9 (1920x1080
					pixelů). Jiné formáty mohou vést k černým pruhům po stranách.
				</p>
			</form>
		</main>
		<script type="module">
			import { renderer } from './renderer.js'
			const STORAGE_KEY = 'last-data'
			const $form = document.querySelector('form')
			const $preview = document.querySelector('#preview')
			const $download = document.querySelector('#download')
			const { render } = renderer($preview, (url) => {
				$download.href = url
			})

			const persistFormData = () => {
				const formData = new FormData($form)
				const data = {}
				for (let [name, value] of formData.entries()) {
					data[name] = value
				}
				localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
			}

			const updatePreview = () => {
				const formData = new FormData($form)
				const parameters = Object.fromEntries(formData.entries())
				render(parameters)
			}

			$form.addEventListener('submit', persistFormData)
			$form.addEventListener(
				'input',
				(() => {
					let timer
					return (event) => {
						persistFormData()
						clearTimeout(timer)
						timer = setTimeout(() => {
							updatePreview()
						}, 500)
					}
				})(),
			)

			try {
				const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}
				for (let [name, value] of Object.entries(data)) {
					const $field = $form.querySelector(`[name="${name}"]`)
					if ($field === null) {
						continue
					}
					if ($field.type === 'checkbox') {
						$field.checked = true
					} else if (!$field.value) {
						$field.value = value
					}
				}
			} catch (error) {
				console.error(error)
			}
			updatePreview()

			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('serviceWorker.js')
			}
		</script>
	</body>
</html>
